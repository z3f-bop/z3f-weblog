name: Sync Weblog to omg.lol

on:
  push:
    branches: [main]
    paths:
      - 'weblog/**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync configuration
        run: |
          curl --fail-with-body -X POST \
            -H "Authorization: Bearer ${{ secrets.OMG_LOL_API_KEY }}" \
            "https://api.omg.lol/address/z3f/weblog/configuration" \
            --data-binary @weblog/config/configuration.txt

      - name: Sync Page Template (Primary)
        run: |
          # Strip frontmatter (first 3 lines) and upload to primary template endpoint
          tail -n +4 weblog/templates/page-template.md | \
          curl --fail-with-body -X POST \
            -H "Authorization: Bearer ${{ secrets.OMG_LOL_API_KEY }}" \
            -H "Content-Type: text/html" \
            "https://api.omg.lol/address/z3f/weblog/template" \
            --data-binary @-

      - name: Sync Landing Page Template (Named)
        run: |
          curl --fail-with-body -X POST \
            -H "Authorization: Bearer ${{ secrets.OMG_LOL_API_KEY }}" \
            "https://api.omg.lol/address/z3f/weblog/entry" \
            --data-binary @weblog/templates/landing-page-template.md

      - name: Sync posts
        run: |
          find weblog/posts -name "*.md" -type f | while read -r post; do
            echo "Syncing: $post"
            curl --fail-with-body -X POST \
              -H "Authorization: Bearer ${{ secrets.OMG_LOL_API_KEY }}" \
              "https://api.omg.lol/address/z3f/weblog/entry" \
              --data-binary @"$post"
          done
